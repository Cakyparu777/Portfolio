version: 1
frontend:
  phases:
    preBuild:
      commands:
        - echo "Starting preBuild phase..."
        - echo "Installing Node.js 20..."
        - nvm install 20
        - nvm use 20
        - echo "Node version:"
        - node --version
        - echo "NPM version:"
        - npm --version
        - echo "Installing dependencies..."
        - npm ci --prefer-offline --no-audit --progress=false
        - echo "Dependencies installed successfully"
    build:
      commands:
        - echo "Starting build phase..."
        - echo "Building Next.js app..."
        - npm run build
        - echo "Build completed successfully"
        - echo "Creating required files for Amplify compatibility..."
        - echo '{}' > out/required-server-files.json
        - mkdir -p out/.next
        - echo '[]' > out/.next/trace
        - echo '{}' > out/.next/server-trace-manifest.json
        - echo '{}' > out/.next/static-trace-manifest.json
        - echo "Listing created files..."
        - ls -la out/.next/
        - echo "Copying trace files to root level..."
        - cp out/.next/trace out/trace
        - cp out/.next/server-trace-manifest.json out/server-trace-manifest.json
        - cp out/.next/static-trace-manifest.json out/static-trace-manifest.json
        - echo "Creating additional trace files..."
        - echo '{}' > out/.next/trace-manifest.json
        - echo '{}' > out/trace-manifest.json
        - echo "Final file listing..."
        - ls -la out/ | head -20
  artifacts:
    baseDirectory: out
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
